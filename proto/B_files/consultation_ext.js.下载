/*mstatic:combine done!*/
/*
 * @Author: qinfan 
 * @Date: 2017-05-11 15:10:22 
 */
;void function () {

    function isUaPhone() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    var tap = ('ontouchend' in document) && isUaPhone() ? 'touchend' : 'click';
    var dialogHTML = '<div class="m-fulldialog J-fulldialog {wrapClass}">' +
        '<div class="fd-header"><div class="fd-back J-goBack"><i class="ob-icon icon-left-big"></i></div><h4 class="fd-title">{title}</h4></div>' +
        '<div class="fd-content J-content"></div>' +
        '<div class="fd-footer">{footer}</div>' +
        '</div>';
    var position;


    var fullDialog = function (config) {
        var defaults = {
            dialogHTML: dialogHTML,
            title: 'TITLE',
            content: 'inner',
            wrapClass: '',
            ok: null,
            cancel: null,
            init: null,
            close: null
        };
        this.conf = $.extend(true, {}, defaults, config);
        this._init();
    };

    fullDialog.prototype = {
        _init: function () {
            this.open();
            this._bindEvent();
            this.conf.init && this.conf.init.call(this, window);
        },
        open: function () {
            var _this = this;
            this._clear();
            var $dom = $(this._replaceHTML());
            $('body').append($dom);
            this.DOM = $dom;
            $dom.find('.J-content').append(this.conf.content.clone ? this.conf.content.clone() : this.conf.content);
            setTimeout(function () {
                _this.DOM.addClass('open');
            }, 0);
            this._bodyOpen();
        },
        _replaceHTML: function () {
            var footerHTML = '<div class="fd-btn-wrap"><button class="fd-btn J-fd-cancel">Cancel</button><button class="fd-btn fd-ok J-fd-ok">Confirm</button></div>';
            return this.conf.dialogHTML
                .replace('{title}', this.conf.title)
                .replace('{wrapClass}', this.conf.wrapClass + (this.conf.ok ? ' with-footer' : ''))
                .replace('{footer}', this.conf.ok ? footerHTML : '');
        },
        close: function () {
            var _this = this;
            if (!this.DOM) return;
            this.DOM.removeClass('open');
            this._bodyClose();
            this.conf.close && this.conf.close.call(this, window);
            setTimeout(function () {
                _this._clear();
            }, 600);
        },
        _clear: function () {
            this.DOM && this.DOM.remove();
            this.DOM = null;
        },
        _bindEvent: function () {
            var _this = this;
            if (!this.DOM) return;

            this.DOM.on(tap, '.J-goBack', function () {
                _this.close();
            });
            this.DOM.on(tap, '.J-fd-cancel', function () {
                if (_this.conf.cancel) {
                    var flag = _this.conf.cancel.call(this, window);
                    if (flag !== false) {
                        _this.close();
                    }
                } else {
                    _this.close();
                }
            });
            this.DOM.on(tap, '.J-fd-ok', function () {
                if (_this.conf.ok) {
                    var flag = _this.conf.ok.call(this, window);
                    if (flag !== false) {
                        _this.close();
                    }
                } else {
                    _this.close();
                }
            })
        },
        _bodyOpen: function () {
            position = $(window).scrollTop(); // 保存滚动条位置 
            $('body').addClass('body-overflow');
            $('html').css({
                overflow: "hidden"
            });
        },
        _bodyClose: function () {
            $('body').removeClass('body-overflow');
            $('html').css({
                overflow: ""
            });
            // 恢复滚动条位置
            $(window).scrollTop(position);
        },
        okdisabled: function () {
            this.DOM && this.DOM.find('.J-fd-ok').prop('disabled', true);
        },
        okabled: function () {
            this.DOM && this.DOM.find('.J-fd-ok').prop('disabled', false);
        },
        setOk: function (cb) {
            this.conf.ok = cb;
        }
    };


    window.fullDialog = fullDialog;

}.call(this);
//
$(function () {
$.validator.addMethod('customFun', function (value, element, param) {
  var customMsg = '';
  var result = false;
  $.ajax({
    url: "crp/validateEmailForCrp",
    async: false,
    type: "GET",
    data: {
      email: value
    },
    timeout: 10000,
    success: function (data) {
      data = JSON.parse(data);
      if (data && data.code === "10001") {
        if (data.data == '0') {
          result = true;
        } else if (data.data == '1') {
          result = false;
          customMsg = 'You have already used this email to submit your information, we will contact you by mail as soon as possible.';
        } else if (data.data == '2') {
          result = false;
          customMsg = 'This email address is already registered. Please use a different email address.';
        }
      } else {
        alert(SILK.ASYNC_ERROR);
      }
    },
    error: function () {
      alert(SILK.ASYNC_ERROR);
    }
  });
  $.validator.messages.customFun = customMsg;
  return result;
});

$.validator.define('consultationForm', {
  userName: {
    required: ['Please enter your name.'],
    maxlength: {
      param: [100],
      message: ["Your name may enter up to 100 characters."]
    }
  },
  userEmail: {
    required: ['Please enter a valid email address.'],
    email: ['Please enter email address in a valid format.'],
    customFun: true
  },
  businessPhone: {
    required: ['Please enter your phone number.'],
    custom: {
      rule: function (value, el) {
        if (value !== '') {
          return /^[\(\)\-\/\.\*\~\x20]*(\d[\(\)\-\/\.\*\~\x20]*){10}[\(\)\-\/\.\*\~\x20]*$/.test(value);
        } else {
          return true;
        }
      },
      message: ['Please enter a valid phone number.']
    }
  },
  // businessType: {
  //   required: ['Please select your business type.']
  // },
  // annualSalesAmount: {
  //   required: ['Please select your annual sales amount.']
  // },
  // category: {
  //   required: ['Please select your main category.']
  // },
  validateCode: {
    required: ['Please enter the characters you see in the picture.']
  }
});

function valider() {
  var valSet = {};
  $(".J-consultation-form").each(function (i) {
    var $wrapForm = $(this);
    var $wrapFormParent = $wrapForm.parent();
    valSet[i] = $(this).validate("consultationForm", {
      errorWrap: true,
      ignore: '.hide *, [readonly], .disabled, .J-ignore, #faptcha_server',
      submitHandler: function (form) {
        var $submit = $(form).find('.J-submit-btn');
        $submit.attr('disabled', true);
        $wrapFormParent.find('.J-errorTips').html('').hide();
        $wrapFormParent.find('.J-alert').hide();
        $.ajax({
          url: "crp/submit",
          type: "POST",
          data: $(form).serialize(),
          dataType: "json",
          success: function (reqdata) {
            if (reqdata.code === "10001") {
              if (reqdata.data === "1") {
                $.ajax({
                  url: "crp/success/" + reqdata.crpId,
                  type: "GET",
                  dataType: "json",
                  complete: function () {}
                });
                artDialog.alert('Thanks for your consultation, we will contact you by mail within 1-3 working days.', "Notice", {
                  text: "Confirm",
                  fn: function () {
                    window.location.reload();
                  }
                }, {
                  type: "tip",
                  close: function () {
                    window.location.reload();
                  }
                });
              } else if (reqdata.data === "0") {
                if (reqdata.validateCodeErrorTip) {
                  $wrapForm.find('.feedback-block').find("label[for='faptcha_response_field']").text(reqdata.validateCodeErrorTip).show();
                }
                if (reqdata.errorTip && reqdata.errorTip.length > 0) {
                  $wrapFormParent.find('.J-errorTips,.J-alert').show();
                  $wrapFormParent.find('.J-errorTips').html('');
                  $.each(reqdata.errorTip, function (i, txt) {
                    $wrapFormParent.find('.J-errorTips').append('<div class="alert-txt">' + txt + '</div>');
                  });
                }
              }
            } else {
              alert(SILK.ASYNC_ERROR);
            }
          },
          error: function () {
            alert(SILK.ASYNC_ERROR);
          },
          complete: function () {
            $submit.removeAttrs('disabled');
            Faptcha.reload();
          }
        });
      }
    });
  });
  return valSet;
}
valider();
    //
    Select.use('select');
    // 初始化回到顶部和客服
    if (window['SlideNav']) {
        var sn = new SlideNav();
        sn.addItem('goTop');
        SlideNav.defaultsInit(sn);
        sn.show();
    }
    // 点击按钮弹出弹框
    var contentHtml = $(".J-form-crp").html();
    $('.J-consulate-btn').on("click", function (e) {
        disputeDialog = new fullDialog({
            title: 'Free Consultation!',
            content: contentHtml,
            init: function () {
                $(".J-form-crp").html('');
                setTimeout(function () {
                    insertForm(1);
                }, 0)
            },
            close: function () {
                $(".J-form-crp").html(contentHtml);
                setTimeout(function () {
                    insertForm(0);
                }, 0)
            }
        })
    })
    //插入顶部表单
    var insertForm = function (i) {
        Faptcha.reload();
        var validForm = valider();
        validForm[i].resetForm();
        $('.J-faptcha #faptcha_response_field').attr('placeholder', 'Verification Code');
    }

    //跳到表单
    $('.J-consulate').on('click', function (e) {
        e.preventDefault();
        var _top = $('.J-form').offset().top;
        var  fixedHeight =0;
        //页头显示
        if (lt1024() && $(this).offset().top > $('.J-form').offset().top ) {
            fixedHeight =$headerWrap.height();
        } else {
            fixedHeight =0;
        }
        // 加Math.ceil()是处理不足1px问题
        $('html,body').animate({
            scrollTop: Math.ceil( _top - fixedHeight)
        }, 300);
    });

    //anniu
    var $nav = $('.J-nav'),
        navHeight = 0;
    var $headerWrap = $('.J-header-wrap');
    var faptchaCopy = $('.J-faptcha').html();
    var showFaptcha = function (el) {
        $(el).html(faptchaCopy);
        Faptcha.init();
        $('.J-faptcha #faptcha_response_field').attr('placeholder', 'Verification Code');
    }

    $(window).scroll(function () {
        var scrolltop = $(window).scrollTop();
        // 滚动高度超过tab位置是fixed
        if (scrolltop > $('.J-products').next().offset().top) { //导航定位
            $nav.addClass('nav-fixed')
        } else {
            $nav.removeClass('nav-fixed')
        }
        // 根据滚动位置确定高亮tab
        var ad1024;
        if (lt1024() && $headerWrap.css('position') == 'fixed' && $headerWrap.hasClass('scroll-in') && $nav.hasClass('nav-fixed')) {
            ad1024 = 110;
        } else {
            ad1024 = 10
        }
        if ((scrolltop < $('.J-products').next().offset().top - navHeight - ad1024)) {
            if (!$('.J-faptcha #faptcha_widget')[0]) {
                showFaptcha('.J-faptcha');
                $('.J-faptcha-middle').html('');
            }

        } else {
            if (!$('.J-faptcha-middle #faptcha_widget')[0]) {
                showFaptcha('.J-faptcha-middle');
                $('.J-faptcha').html('');
            }
        }
        if ((scrolltop >= $('.J-form').offset().top - navHeight - ad1024)||(scrolltop < $('.J-products').next().offset().top- navHeight - ad1024)) {
            $nav.hide();
        }else{
            $nav.show();
        }
        // 根据公共头是否显示，设置tab位置
        if (lt1024() && $headerWrap.css('position') == 'fixed' && $headerWrap.hasClass('scroll-in') && $nav.hasClass('nav-fixed')) {
            $nav.css('top', '110px');
        } else {
            $nav.css('top', 0);
        }
    });

    function lt1024() {
        var screenType = window.getComputedStyle && window.getComputedStyle($('.J-header-wrap')[0], ":before").getPropertyValue("content");
        return screenType && screenType.indexOf('LT1024') !== -1;
    }
    setTimeout(function () {
        $('.J-faptcha #faptcha_response_field').attr('placeholder', 'Verification Code');
    }, 0)

})
