$(function () {
    var app = {
        _init: function () {
            this._getStart();
            this._event();
        },
        _getStart: function () {
            // 初始化回到顶部和客服
            if (window['SlideNav']) {
                var sn = new SlideNav();
                sn.addItem('liveChat');
                sn.addItem('goTop');
                SlideNav.defaultsInit(sn);
                sn.show();
            }
            this._renderBannerSwiper();
            // About the Manufacturer轮播图
            this._renderAtmSwiper();
            // // Previous 599 Program Participants轮播图
            // this._renderP5ppSwiper();
        },
        /* 渲染 banner 部分轮播 */
        _renderBannerSwiper: function () {
            var swiper = new Swiper('.J-banner-swiper', {
                loop: true,
                autoplay: true,
                delay: 3000
            });
        },
        /* 渲染 About the Manufacturer 部分轮播 */
        _renderAtmSwiper: function () {
            var swiper = new Swiper('.J-atm-swiper', {
                loop: true,
                autoplay: true,
                delay: 3000,
                pagination: {
                    el: '.J-atm-pagination',
                    clickable: true,
                },
                navigation: {
                    nextEl: '.atm-nav-next',
                    prevEl: '.atm-nav-prev'
                }
            });
            swiper.el.onmouseover = function () {
                swiper.autoplay.stop();
            }
            swiper.el.onmouseleave = function () {
                swiper.autoplay.start();
            }
        },

        _event: function () {
            /* 点击照片墙展示大图 */
            $('.J-photo-wall').on('click', '.photo-wall-item', function () {
                var that = this;
                if ($('.J-main-dialog').length === 0) {
                    var dia = template($('#enlargeTpl').html(), {})
                    $('body').append(dia);
                    var html = '';
                    var imgList = [];
                    var ptotoWall = $('.photo-wall-wrap li.photo-wall-item');
                    for (var i = 0; i < ptotoWall.length; i++) {
                        html += '<div class="swiper-slide"><img class="large-img" src="' + ptotoWall.eq(i).find('img').attr('src') + '" alt=""></div>';
                    }

                    $('.J-main-dialog .swiper-wrapper').html(html)
                }

                $('.J-main-shadow').fadeIn();
                $('.J-main-dialog').fadeIn();
                $("body").css("overflow-y", "hidden");

                /* 渲染照片墙轮播 */
                var mySwiper = new Swiper('.J-dialog-swiper', {
                    autoplay: false,
                    loop: true,
                    navigation: {
                        nextEl: '.dialog-nav-next',
                        prevEl: '.dialog-nav-prev',
                    },
                    initialSlide: $(that).index()
                });
            });

            /* 弹窗点击遮罩层关闭弹窗 */
            $(document).on('click', '.J-main-dialog', function (e) {
                var tar = e.target;
                if ($(tar).hasClass('dialog-nav-next') || $(tar).hasClass('dialog-nav-prev') || $(tar).hasClass('large-img')) {
                    return false;
                }
                $('.J-main-shadow').fadeOut();
                $('.J-main-dialog').fadeOut();
                $("body").css("overflow-y", "auto");
            });

            /* 鼠标悬浮轮播图的分页器 */
            $(document).on('mouseenter', '.swiper-pagination-bullet', function () {
                $(this).trigger('click');
            });

            $('.J-mr-swiper').on('click', '.quotes-text', function () {
                new artDialog({
                    title: false,
                    content: $(this).html(),
                    width: '40%',
                    fixed: true,
                    lock: true,
                    resize: false,
                    drag: false,
                })
            });


            $(window).resize(function () {
                resetTab();
                if (typeof (editDialog) == "object" && $('.dlg-dialog').parent('div').css('display') == "block") {
                    if ($(window).width() < 768) {
                        editDialog.size('100%', $(window).height() - 91);
                        $('.J-topic-form').closest('.dlg-state-focus').addClass('dlg-top');
                        $('.J-topic-form').closest('.dlg-content').addClass('dlg-scroll');
                    } else {
                        if ($('.J-topic-form').closest('.dlg-dialog').height() > $(window).height()) {
                            editDialog.size("auto", $(window).height() - 91);
                            $('.J-topic-form').closest('.dlg-content').addClass('dlg-scroll');
                        } else {
                            editDialog.size("auto", "auto");
                            $('.J-topic-form').closest('.dlg-content').removeClass('dlg-scroll');
                        }
                        $('.J-topic-form').closest('.dlg-state-focus').removeClass('dlg-top');
                    }
                   
                }
            })


            //去掉最后一个逗号
            $(document).on('change', '.J-cooperationMode input[type=checkbox]', function () {
                var reg = /,$/gi;
                var tagsNum = "";
                $(".J-cooperationMode input[type=checkbox]:checked").each(function () {
                    tagsNum += $(this).attr("data-tag") + ",";
                });
                tagsNum = tagsNum.replace(reg, "");
                $('.J-cooperationMode input[name=cooperationMode]').val(tagsNum);
                $(".J-topic-form .J-cooperationMode input[name=cooperationMode]").valid();
            });

            $(".J-product-item").click(function () {
                var _this = $(this);
                Faptcha.reload();
                var formContent; //productInfo信息
                // ##        todo:如通过B类买家优势栏目中Get Resale Price按钮打开，则不展示Product info.；
                if (_this.attr('data-notShowInfo')) {
                    formContent = '';
                } else {
                    formContent =
                        '<div class="jump-product">' +
                        '<div class="img-box">' +
                        '<a class="img-cnt" href="javascript:;">' +
                        $(this).closest('.J-prod-item-block-wrap').find('.J-img-cnt').html() +
                        '</a>' +
                        '</div>' +
                        '<p>' + _this.attr('data-product') + '</p>' +
                        '</div>';
                }
                var formBlock = '<div class="m-alert J-account-err-wrap hide">' +
                    '<div class="alert-con alert-err alert-state">' +
                    '<span class="micon-state"><i class="ob-icon icon-error"></i></span>' +
                    '<span class="alert-txt J-account-err-tip"></span>' +
                    '</div></div>' + '<p class="resell-tip">For a Z Grills reseller, we can provide you drop shipping / bulk buy / distribution services, we will offer you the quotation in 1 working day and try our best to help your business up.</p>' +
                    formContent +
                    template($('#formTpl').html(), {});
                editDialog = new artDialog({
                    title: 'Want to Resell',
                    content: formBlock,
                    fixed: true,
                    lock: true,
                    width: $(window).width() < 768 ? "100%" : "auto",
                    height: $(window).width() < 768 ? "100%" : "auto",
                    init: function () {
                        $('.J-faptcha-placehold').html($('.J-faptcha-wrap').html());
                        if (!_this.attr('data-notShowInfo')) {
                            $('.J-topic-form input[name="encryptSkuId"]').val(_this.attr('data-id'));
                        }
                        var validator = $(".J-topic-form").validate("commodityTopicsForm", {
                            errorWrap: true,
                            ignore: ".hide *,.J-ignore",
                        });
                        validator.resetForm();
                    },
                    ok: function () {
                        $('.J-account-err-wrap').hide();
                        if ($(".J-topic-form").valid()) {
                            var $submit = $('.dlg-dialog').find('button:first');
                            $submit.attr('disabled', true);
                            $.ajax({
                                url: "/promotions/zgirlls_mail",
                                type: "POST",
                                data: $(".J-topic-form").serialize(),
                                dataType: "json",
                                success: function (reqdata) {
                                    if (reqdata.code === "10001") {
                                        editDialog.close();
                                        artDialog.alert('Thanks for contacting us, we will reply to you within 1 working day.', "Notice", {
                                            text: "Confirm",
                                            fn: function () {}
                                        }, {
                                            type: "tip",
                                            close: function () {}
                                        });
                                    } else if (reqdata.code === "10002" && reqdata.data) {
                                        $('.J-account-err-wrap').show();
                                        $('.J-account-err-wrap').find(".J-account-err-tip").text(reqdata.data).show();
                                        Faptcha.reload();
                                    }
                                },
                                error: function () {
                                    alert(SILK.ASYNC_ERROR);
                                },
                                complete: function () {
                                    $submit.removeAttrs('disabled');
                                }
                            });
                        }
                        return false;
                    },
                    okVal: 'Send',
                    cancel: function () {
                        return true;
                    },
                    cancelVal: 'Cancel',
                    close: function () {
                        if ($("html").css('overflow') == "hidden") {
                            $("body,html").css("overflow", "");
                            looseBody();
                            $("body").css({
                                "width": ""
                            });
                        }
                    },

                });
                if ($(window).width() < 768) {
                    $("body,html").css("overflow", "hidden");
                    editDialog.size('100%', $(window).height() - 91);
                    $('.J-topic-form').closest('.dlg-state-focus').addClass('dlg-top');
                    $('.J-topic-form').closest('.dlg-content').addClass('dlg-scroll');
                    $("body").css({
                        "position": "fixed",
                        "top": -$(window).scrollTop(),
                        "width": "100%"
                    });
                } else {
                    if ($('.J-topic-form').closest('.dlg-dialog').height() > $(window).height()) {
                        editDialog.size("auto", $(window).height() - 91);
                        $('.J-topic-form').closest('.dlg-content').addClass('dlg-scroll');
                    } else {
                        editDialog.size("auto", "auto");
                        $('.J-topic-form').closest('.dlg-content').removeClass('dlg-scroll');
                    }
                }
            });
            //视频播放
            $(".J-cover-img-wrap").click(function (e) {
                e.preventDefault();
                var videoSrc = $(this).attr("data-video") + '?enablejsapi=1&rel=0&autoplay=1';
                $(".J-dlg-video-wrap").find(".J-video-iframe").attr("src", videoSrc);
                $("body,html").css("overflow", "hidden");
                $(".J-dlg-video-wrap").fadeIn();
                $("body").css({
                    "position": "fixed",
                    "top": -$(window).scrollTop(),
                    "width": "100%"
                });
            });
            $(".J-dlg-video-close").click(function () {
                $(".J-dlg-video-wrap").find(".J-video-iframe").attr("src", "");
                $("body,html").css("overflow", "");
                $(".J-dlg-video-wrap").fadeOut();
                looseBody();
                $("body").css({
                    "width": ""
                });
            });
            //ipad触屏端播放视频时，页面仍然能滑动
            function looseBody() {
                var body = document.body;
                body.style.position = '';
                var top = body.style.top;
                document.body.scrollTop = document.documentElement.scrollTop = -parseInt(top);
                body.style.top = '';
            }


            /*表单验证*/
            $.validator.define("commodityTopicsForm", {
                contactPerson: {
                    required: {
                        message: ["Please enter your name.", ""]
                    },
                    maxlength: {
                        param: 50,
                        message: ["Name may only be up to 50 characters.", ""]
                    }
                },
                email: {
                    required: {
                        message: ["Please enter a valid email address.", ""]
                    },
                    email: {
                        message: ["Please enter email address in a valid format.", ""]
                    },
                    maxlength: {
                        param: 160,
                        message: ["Email address may only be up to 160 characters.", ""]
                    }
                },
                mobile: {
                    required: ['Please enter your phone number.'],
                    digits: ['Please provide a valid phone number.'],
                    custom: {
                        rule: function (value, el) {
                            if (value !== '') {
                                return (value.match(/\d/g).length === 10);
                            } else {
                                return true;
                            }
                        },
                        message: ['Please provide a valid phone number.']
                    }
                },
                cooperationMode: {
                    required: {
                        message: ["Please select the cooperation mode you need.", ""]
                    }
                },
                salesChannel: {
                    required: {
                        message: ["Please select at least one of your sales channels.", ""]
                    }
                },
                salesChannel1: {
                    required: {
                        message: ["Please enter your online website address.", ""]
                    },
                    maxlength: {
                        param: 500,
                        message: ["Online website address may only be up to 500 characters.", ""]
                    }
                },
                salesChannel2: {
                    required: {
                        message: ["Please enter your offline store name & address.", ""]
                    },
                    maxlength: {
                        param: 500,
                        message: ["Offline store name & address may only be up to 500 characters.", ""]
                    }
                },
                salesChannel3: {
                    required: {
                        message: ["Please enter your other sales channel.", ""]
                    },
                    maxlength: {
                        param: 500,
                        message: ["Other sales channel may only be up to 500 characters.", ""]
                    }
                },
                validateCode: {
                    required: {
                        message: ["Other sales channel may only be up to 500 characters.", ""]
                    }
                }
            });

            var $nav = $('#J-nav'),
                navHeight = 0;
            var $headerWrap = $('.J-header-wrap');

            function pipeString(str) {
                return str.toLowerCase().replace(/[^a-zA-Z0-9]/g, ' ').replace(/\s+/g, '-');
            }

            $('.J-nav-item').click(function (e) {
                e.stopPropagation();
                var fixedHeight = navHeight;
                var $this = $(this);
                var index = $this.index();
                if (lt1024() && index < $('.J-nav-item a.current').parent().index()) {
                    fixedHeight = navHeight + $headerWrap.height();
                } else {
                    fixedHeight = navHeight;
                }
                // 加Math.ceil()是处理不足1px问题
                $('html,body').animate({
                    scrollTop: Math.ceil($('.J-prod-box').eq(index).offset().top - fixedHeight)
                }, 300);
            });
            var timer = null;
            $(window).scroll(function () {
                var scrolltop = $(window).scrollTop();
                if ($nav.length < 1) {
                    return false;
                }
                // 滚动高度超过tab位置是fixed
                if (scrolltop > $nav.parent().offset().top) { //导航定位
                    $nav.addClass('nav-fixed')
                } else {
                    $nav.removeClass('nav-fixed')
                }
                // 根据滚动位置确定高亮tab
                $('.J-nav-item').each(function () {
                    var $this = $(this);
                    var index = $this.index();
                    var ad1024;
                    if (lt1024() && $headerWrap.css('position') == 'fixed' && $headerWrap.hasClass('scroll-in') && $nav.hasClass('nav-fixed')) {
                        ad1024=110;
                    } else {
                        ad1024=10
                    }
                    if (scrolltop >= $('.J-prod-box').eq(index).offset().top - navHeight - ad1024) {
                        $('.J-nav-item a').removeClass('current');
                        $this.find('a').addClass('current');
                        clearTimeout(timer);
                        timer = setTimeout(function () {
                            window.location.hash = pipeString($this.find('a').text());
                        }, 50)
                    }
                });

                // 根据公共头是否显示，设置tab位置
                if (lt1024() && $headerWrap.css('position') == 'fixed' && $headerWrap.hasClass('scroll-in') && $nav.hasClass('nav-fixed')) {
                    $('#J-nav').css('top', '110px');
                } else {
                    $('#J-nav').css('top', 0);
                }

                resetTab();

            });

            function lt1024() {
                var screenType = window.getComputedStyle && window.getComputedStyle($('.J-header-wrap')[0], ":before").getPropertyValue("content");
                return screenType && screenType.indexOf('LT1024') !== -1;
            }

            function resetTab() {
                if ($nav.length < 1) {
                    return false;
                }
                navHeight = $nav.height();
            }

            
            resetTab();
            // 地址栏锚点跳转
            var url = window.location.href;
            if (url.lastIndexOf('#') != -1) {
                var skuCode = url.substr(url.lastIndexOf('#') + 1);
                $('[data-anchor]').each(function () {
                    var $this = $(this),
                        anchor = pipeString($this.attr('data-anchor'));
                    $this.attr('data-anchor', anchor);
                    if (skuCode === anchor) {
                        var top = Math.ceil($this.offset().top - navHeight);
                        $('html,body').animate({
                            scrollTop: top
                        }, 300);
                    }
                });

            }

        }
    };
    app._init();
})
